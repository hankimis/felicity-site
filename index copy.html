<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Onbit - 암호화폐 거래소 정보 및 실시간 분석</title>
  <meta name="description" content="실시간 암호화폐 분석, 고래 추적, 거래소 정보를 제공하는 Onbit에서 최신 코인 시장 동향을 확인하세요.">
  
  <!-- Preconnect to external domains for faster loading -->
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://api.binance.com">
  <link rel="preconnect" href="https://s3.tradingview.com">
  <link rel="dns-prefetch" href="https://s3.tradingview.com">
  <link rel="preload" href="https://s3.tradingview.com/tv.js" as="script">
  
  <!-- Critical CSS - Only essential above-the-fold styles -->
  <style>
    /* Critical CSS Variables */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --accent-blue: #3b82f6;
      --primary-color: #3b82f6;
      --border-default: #e2e8f0;
      --shadow-light: rgba(0, 0, 0, 0.08);
    }

    /* 라이트 모드 */

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
    }

    /* Critical Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
      line-height: 1.6;
    }

    /* Critical Loading Animation */
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    /* Critical Main Banner - UIKit 스타일 */
    .main-banner {
      width: 100%;
      padding: 40px 0 40px;
      background: var(--bg-secondary);
      position: relative;
      overflow: hidden;
    }


    

    


    .banner-container {
      width: 90%;
      max-width: 1400px;
      height: 580px;
      margin: 0 auto;
      position: relative;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    </style>
  
  <!-- Index Page Specific CSS -->
  <link rel="stylesheet" href="_testindex.css">

  </style>
  
  <!-- Favicon and icons -->
  <link rel="icon" type="image/png" href="/onbit/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/onbit/favicon.svg" />
  <link rel="shortcut icon" href="/onbit/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/onbit/apple-touch-icon.png" />
  <link rel="manifest" href="/onbit/site.webmanifest" />
  
  <!-- Load critical CSS files -->
  <link rel="stylesheet" href="css/style.css">

    <link rel="stylesheet" href="css/popup-banner.css">
  <link rel="stylesheet" href="auth.css">
  
  <!-- Preload critical fonts -->
  <link rel="preload" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard-dynamic-subset.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard-dynamic-subset.css"></noscript>
  
  <!-- Defer Font Awesome -->
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"></noscript>

  <!-- Critical scripts that must load immediately -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script src="https://s3.tradingview.com/tv.js" async defer></script>
</head>
<body>
  <!-- Header placeholder -->
  <div id="header-placeholder"></div>

  <!-- TradingView Widget BEGIN -->
  <div class="tradingview-widget-container">
    <div class="tradingview-widget-container__widget"></div>
    <script type="text/javascript" async src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js">
    {
      "symbols": [
        {
          "proName": "FOREXCOM:SPXUSD",
          "title": "S&P 500"
        },
        {
          "proName": "FOREXCOM:NSXUSD", 
          "title": "나스닥"
        },
        {
          "proName": "FX_IDC:EURUSD",
          "title": "EUR/USD"
        },
        {
          "proName": "BITSTAMP:BTCUSD",
          "title": "비트코인"
        },
        {
          "proName": "BITSTAMP:ETHUSD",
          "title": "이더리움"
        },
        {
          "proName": "BINANCE:BNBUSDT",
          "title": "BNB"
        },
        {
          "proName": "BINANCE:ADAUSDT",
          "title": "카르다노"
        },
        {
          "proName": "BINANCE:DOTUSDT",
          "title": "폴카닷"
        }
      ],
      "showSymbolLogo": true,
      "isTransparent": false,
      "displayMode": "adaptive",
      "colorTheme": "light",
      "locale": "kr"
    }
    </script>
  </div>
  <!-- TradingView Widget END -->

  <section class="main-banner">
    <div class="banner-content">
      <div class="banner-text">
        <div class="banner-features">
          <div class="feature-item">
            <i class="fas fa-percentage"></i>
            <span>최대 40% 수수료 페이백</span>
          </div>
          <div class="feature-item">
            <i class="fas fa-clock"></i>
            <span>실시간 정산</span>
          </div>
          <div class="feature-item">
            <i class="fas fa-shield-alt"></i>
            <span>안전한 거래 보장</span>
          </div>
        </div>
        <h1 class="banner-title">
          암호화폐 커뮤니티의 새로운 <span class="highlight">표준</span>
          <br><span class="highlight">온비트</span><span class="black-text">에서 시작하세요</span>
        </h1>
        <p class="banner-subtitle">
          제휴 거래소 이용 시 거래 수수료의 일부를 페이백으로 돌려받으세요
        </p>
        <div class="banner-cta">
          <a href="/affiliated/" class="cta-button primary">
            <i class="fas fa-rocket"></i>
            제휴 거래소 보기
          </a>
          <a href="/affiliated/payback-calculator/" class="cta-button secondary">
            <i class="fas fa-calculator"></i>
            페이백 계산하기
          </a>
        </div>
      </div>
      <div class="banner-image">
        <img src="/assets/mainbanner/mainbanner.png" alt="온비트 메인 배너" loading="lazy">
      </div>
      <div class="banner-exchanges">
        <div class="exchanges-grid">
          <a href="/affiliated/" class="exchange-item">
            <img src="/assets/logoicon/binance.webp" alt="Binance" class="exchange-logo">
            <span class="exchange-name">Binance</span>
          </a>
          <a href="/affiliated/bitget/" class="exchange-item">
            <img src="/assets/logoicon/bitget.png" alt="Bitget" class="exchange-logo">
            <span class="exchange-name">Bitget</span>
          </a>
          <a href="/affiliated/okx/" class="exchange-item">
            <img src="/assets/logoicon/okx.png" alt="OKX" class="exchange-logo">
            <span class="exchange-name">OKX</span>
          </a>
          <a href="/affiliated/lbank/" class="exchange-item">
            <img src="/assets/logoicon/lbank.png" alt="LBank" class="exchange-logo">
            <span class="exchange-name">LBank</span>
          </a>
        </div>
      </div>
    </div>
  </section>
  
  <!-- 서비스 카드 그리드 섹션 -->
  <section class="service-cards-section">
    <div class="service-cards-container">
      <div class="service-card">
        <div class="service-card-image">
          <img src="/assets/service-cards/거래소 페이백.png" alt="서비스 타이틀" loading="lazy">
        </div>
        <div class="service-card-content">
          <h3 class="service-card-title">페이백</h3>
          <p class="service-card-description">거래 수수료, 온비트로 돌려받으세요</p>
          <a href="#" class="service-card-button">페이백 받기</a>
        </div>
      </div>
      
      <div class="service-card">
        <div class="service-card-image">
          <img src="/assets/service-cards/트레이딩뷰 차트.png" alt="트레이딩뷰 차트" loading="lazy">
        </div>
        <div class="service-card-content">
          <h3 class="service-card-title">트레이딩뷰 차트</h3>
          <p class="service-card-description">실시간 차트 분석, 한눈에 보기 쉽게</p>
          <a href="#" class="service-card-button">차트 보기</a>
        </div>
      </div>
      
      <div class="service-card">
        <div class="service-card-image">
          <img src="/assets/service-cards/실시간 커뮤니티.png" alt="실시간 커뮤니티" loading="lazy">
        </div>
        <div class="service-card-content">
          <h3 class="service-card-title">실시간 커뮤니티</h3>
          <p class="service-card-description">트레이더들과 자유 바로 소통하세요</p>
          <a href="#" class="service-card-button">지금 소통하기</a>
        </div>
      </div>
      
      <div class="service-card">
        <div class="service-card-image">
          <img src="/assets/service-cards/코인 뉴스.png" alt="코인 뉴스" loading="lazy">
        </div>
        <div class="service-card-content">
          <h3 class="service-card-title">코인 뉴스</h3>
          <p class="service-card-description">빠르고 정확한 암호화폐 뉴스 요약</p>
          <a href="#" class="service-card-button">뉴스 보기</a>
        </div>
      </div>
    </div>
  </section>


  <!-- 실시간 코인 시세 테이블 섹션 -->
    <section class="crypto-table-section">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-coins"></i>
          실시간 코인 시세
        </h3>
        <div class="table-controls">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="coin-search" placeholder="코인 검색...">
          </div>
          <button class="refresh-btn" id="refresh-data">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>
      
      <div class="crypto-table-wrapper">
                 <div class="table-tabs">
           <button class="tab-btn active" data-category="all">전체</button>
           <button class="tab-btn" data-category="gainers">상승</button>
           <button class="tab-btn" data-category="losers">하락</button>
         </div>
        
        <div class="crypto-table-container">
                     <table class="crypto-table" id="crypto-table">
             <thead>
               <tr>
                 <th class="sortable rank-col" data-sort="rank">순위</th>
                 <th class="sortable name-col" data-sort="name">코인</th>
                 <th class="sortable price-col" data-sort="price">가격</th>
                 <th class="sortable change-col" data-sort="change1h">가격(1H%)</th>
                 <th class="sortable change-col" data-sort="change24h">가격(24H %)</th>
                 <th class="sortable funding-col" data-sort="fundingRate">자금 조달 비율</th>
                 <th class="sortable volume-col" data-sort="volume">24H 볼륨($)</th>
                 <th class="sortable oi-col" data-sort="openInterest">OI($)</th>
                 <th class="sortable oi-change-col" data-sort="oiChange1h">OI(1H%)</th>
                 <th class="sortable oi-change-col" data-sort="oiChange4h">OI(4H%)</th>
                 <th class="sortable market-col" data-sort="marketCap">Market Cap($)</th>
                 <th class="sortable liquidation-col" data-sort="liquidation1h">1H 청산($)</th>
                 <th class="sortable liquidation-col" data-sort="liquidation24h">24H 청산($)</th>
                 <th class="chart-col">차트</th>
               </tr>
             </thead>
            <tbody id="crypto-table-body">
              <!-- 코인 데이터가 여기에 동적으로 추가됩니다 -->
            </tbody>
          </table>
        </div>
        
        <div class="table-pagination">
          <button class="page-btn" id="prev-page" disabled>이전</button>
          <span class="page-info" id="page-info">1 / 1</span>
          <button class="page-btn" id="next-page">다음</button>
        </div>
      </div>
    </section>



  <!-- 고래 거래 설정 모달 -->
  <div id="whale-settings-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>고래 거래 추적 설정</h2>
        <button class="modal-close" id="close-whale-settings">&times;</button>
      </div>
      <div class="modal-body">
        <div id="whale-settings-list">
          <!-- 설정 항목들이 여기에 동적으로 추가됩니다 -->
        </div>
      </div>
      <div class="modal-footer">
        <button id="save-whale-settings" class="btn btn-primary">설정 저장</button>
      </div>
    </div>
  </div>

  <!-- 공식 파트너 슬라이드 시작 -->
  <section class="partner-slider-section">
    <div class="partner-grid-header">
        <p class="partner-grid-pre-title">주요 파트너사들과 공식계약 체결</p>
        <h2 class="partner-grid-title">세계 최고의 가상 자산 거래소들과<br>함께하는 ONBit</h2>
    </div>
    <div class="partner-slider">
        <div class="partner-track" id="track1">
            <div class="partner-logo-item"><img src="assets/partner/lbank.png" alt="Lbank"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitget.png" alt="Bitget"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitmex.png" alt="Bitmex"></div>
            <div class="partner-logo-item"><img src="assets/partner/okx.png" alt="OKX"></div>
            <div class="partner-logo-item"><img src="assets/partner/tradingview.png" alt="TradingView"></div>
            <div class="partner-logo-item"><img src="assets/partner/onbit.png" alt="Onbit"></div>
            <div class="partner-logo-item"><img src="assets/partner/binance.png" alt="Binance"></div>
            <div class="partner-logo-item"><img src="assets/partner/lbank.png" alt="Lbank"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitget.png" alt="Bitget"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitmex.png" alt="Bitmex"></div>
            <div class="partner-logo-item"><img src="assets/partner/okx.png" alt="OKX"></div>
            <div class="partner-logo-item"><img src="assets/partner/tradingview.png" alt="TradingView"></div>
            <div class="partner-logo-item"><img src="assets/partner/onbit.png" alt="Onbit"></div>
            <div class="partner-logo-item"><img src="assets/partner/binance.png" alt="Binance"></div>
            <div class="partner-logo-item"><img src="assets/partner/lbank.png" alt="Lbank"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitget.png" alt="Bitget"></div>
        </div>
        <div class="partner-track" id="track2">
            <div class="partner-logo-item"><img src="assets/partner/lbank.png" alt="Lbank"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitget.png" alt="Bitget"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitmex.png" alt="Bitmex"></div>
            <div class="partner-logo-item"><img src="assets/partner/okx.png" alt="OKX"></div>
            <div class="partner-logo-item"><img src="assets/partner/tradingview.png" alt="TradingView"></div>
            <div class="partner-logo-item"><img src="assets/partner/onbit.png" alt="Onbit"></div>
            <div class="partner-logo-item"><img src="assets/partner/binance.png" alt="Binance"></div>
            <div class="partner-logo-item"><img src="assets/partner/lbank.png" alt="Lbank"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitget.png" alt="Bitget"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitmex.png" alt="Bitmex"></div>
            <div class="partner-logo-item"><img src="assets/partner/okx.png" alt="OKX"></div>
            <div class="partner-logo-item"><img src="assets/partner/tradingview.png" alt="TradingView"></div>
            <div class="partner-logo-item"><img src="assets/partner/onbit.png" alt="Onbit"></div>
            <div class="partner-logo-item"><img src="assets/partner/binance.png" alt="Binance"></div>
            <div class="partner-logo-item"><img src="assets/partner/lbank.png" alt="Lbank"></div>
            <div class="partner-logo-item"><img src="assets/partner/bitget.png" alt="Bitget"></div>
        </div>
    </div>
</section>


  <!-- Footer placeholder -->
  <div id="footer-placeholder"></div>

  <!-- Scripts - Load in correct order -->
  <script src="js/auth.js"></script>
  <script src="js/header-loader.js"></script>
  <script src="js/footer-loader.js"></script>
  
<script src="js/popup-banner.js"></script>
  <script src="js/analysis/longshort-tracker.js" type="module"></script>
  <script src="js/analysis/whale-tracker.js" type="module"></script>
  <script src="js/compound-calculator.js" type="module"></script>
  <!-- html2canvas for modal capture -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="module">
    // Whale Tracker 초기화
    import { WhaleTracker } from './js/analysis/whale-tracker.js';
    
    // DOM 로드 후 초기화
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        try {
          window.whaleTracker = new WhaleTracker();
          console.log('Whale Tracker 초기화 완료');
        } catch (error) {
          console.error('Whale Tracker 초기화 실패:', error);
        }
      }, 1000);
    });
  </script>
  <script src="js/compound-calculator.js" type="module"></script>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  
  <!-- Firebase SDK for Events -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { firebaseConfig } from './firebase-config.js';
    
    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // 전역 변수로 Firebase 객체들 노출 (바인딩 유지)
    window.firebaseDB = db;
    window.firebaseCollection = collection.bind(null, db);
    window.firebaseGetDocs = getDocs;
    window.firebaseQuery = query;
    window.firebaseOrderBy = orderBy;
    window.firebaseLimit = limit;
    
    // Firebase 초기화 완료 플래그
    window.firebaseInitialized = true;
    
    console.log('Firebase 초기화 완료');
    
    // Firebase 초기화 완료 이벤트 발생
    window.dispatchEvent(new CustomEvent('firebaseInitialized'));
  </script>

  <script>
    // 페이지 초기화
    document.addEventListener('DOMContentLoaded', function() {

      
      // 페이지별 초기화 함수 호출
      if (typeof initializePage === 'function') {
        initializePage();
      }
      
      // TradingView 차트 즉시 초기화
      if (window.TradingView) {
        // 선택된 심볼로 초기화
        const chartSymbol = document.getElementById('chart-symbol');
        const initialSymbol = chartSymbol ? chartSymbol.value : 'BTCUSDT';
        initializeTradingViewChart(initialSymbol);
      } else {
        // TradingView 라이브러리가 로드될 때까지 짧은 간격으로 체크
        let checkCount = 0;
        const checkTradingView = setInterval(() => {
          checkCount++;
          if (window.TradingView) {
            clearInterval(checkTradingView);
            // 선택된 심볼로 초기화
            const chartSymbol = document.getElementById('chart-symbol');
            const initialSymbol = chartSymbol ? chartSymbol.value : 'BTCUSDT';
            initializeTradingViewChart(initialSymbol);
          } else if (checkCount > 50) { // 5초 후 포기
            clearInterval(checkTradingView);
            console.warn('TradingView 라이브러리 로딩 타임아웃');
          }
        }, 100);
      }
    });
    
        // 전역 TradingView 위젯 인스턴스
    let tradingViewWidget = null;
    let currentChartSymbol = 'BTCUSDT';

    // 현재 시간 프레임 저장
    let currentTimeframe = '1';

    // TradingView 차트 초기화 함수 (최적화)
    function initializeTradingViewChart(symbol = 'BTCUSDT', interval = null) {
      const chartContainer = document.getElementById('tradingview_chart');
      if (!chartContainer) {
        console.warn('차트 컨테이너를 찾을 수 없습니다.');
            return;
          }

      try {
        // 로딩 표시 제거
        const loadingElement = document.getElementById('chart-loading');
        if (loadingElement) {
          loadingElement.style.display = 'none';
        }
        
        // 기존 위젯이 있다면 제거
        if (tradingViewWidget) {
          try {
            tradingViewWidget.remove();
          } catch (e) {
            console.warn('기존 위젯 제거 중 오류:', e);
          }
        }
        
        // 컨테이너 초기화
        chartContainer.innerHTML = '';
        
        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
        currentChartSymbol = symbol;
        
        // 시간 프레임 설정 (interval이 제공되면 사용, 아니면 현재 설정 사용)
        const timeframe = interval || currentTimeframe;
        
        tradingViewWidget = new TradingView.widget({
          "autosize": true,
          "symbol": `BINANCE:${symbol}`,
          "interval": timeframe,
          "timezone": "Asia/Seoul",
          "theme": isDarkMode ? "dark" : "light",
          "style": "1",
          "locale": "ko",
          "toolbar_bg": isDarkMode ? "#1e222d" : "#f1f3f6",
          "enable_publishing": false,
          "hide_top_toolbar": true,
          "hide_legend": false,
          "hide_side_toolbar": false,
          "save_image": false,
          "container_id": "tradingview_chart",
          "disabled_features": [
            "use_localstorage_for_settings",
            "volume_force_overlay",
            "create_volume_indicator_by_default"
          ],
          "enabled_features": [
            "study_templates"
          ],
          "loading_screen": {
            "backgroundColor": isDarkMode ? "#1e222d" : "#ffffff",
            "foregroundColor": isDarkMode ? "#ffffff" : "#000000"
          },
          "overrides": {
            "paneProperties.background": isDarkMode ? "#1e222d" : "#ffffff",
            "paneProperties.vertGridProperties.color": isDarkMode ? "#363c4e" : "#e1e3e6",
            "paneProperties.horzGridProperties.color": isDarkMode ? "#363c4e" : "#e1e3e6"
          }
        });
        
      } catch (error) {
        console.error('TradingView 차트 초기화 실패:', error);
        // 백업 차트 표시
        chartContainer.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
            <div style="text-align: center;">
              <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem;"></i>
              <div>차트를 불러오는 중...</div>
            </div>
          </div>
        `;
      }
    }

    // 분봉 변경 함수
    function changeTimeframe(timeframe) {
      currentTimeframe = timeframe;
      
      // 드롭다운 값 업데이트
      const timeframeSelect = document.getElementById('chart-timeframe');
      if (timeframeSelect) {
        timeframeSelect.value = timeframe;
      }
      
      // 현재 심볼로 차트 재초기화
      const chartSymbol = document.getElementById('chart-symbol');
      const symbol = chartSymbol ? chartSymbol.value : 'BTCUSDT';
      
      // 로딩 표시
      const chartContainer = document.getElementById('tradingview_chart');
      if (chartContainer) {
        chartContainer.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
            <div style="text-align: center;">
              <div class="loading-spinner" style="width: 40px; height: 40px; border: 3px solid var(--border-color); border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
              <div>분봉 변경 중...</div>
            </div>
          </div>
        `;
      }
      
      setTimeout(() => {
        initializeTradingViewChart(symbol, timeframe);
      }, 300);
    }

    // 차트 심볼 변경 함수
    function changeChartSymbol(symbol) {
      // 로딩 표시
      const chartContainer = document.getElementById('tradingview_chart');
      if (chartContainer) {
        chartContainer.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
            <div style="text-align: center;">
              <div class="loading-spinner" style="width: 40px; height: 40px; border: 3px solid var(--border-color); border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
              <div>차트 변경 중...</div>
            </div>
          </div>
        `;
      }
      
      // 새로운 심볼로 차트 재초기화 (현재 시간 프레임 유지)
      setTimeout(() => {
        initializeTradingViewChart(symbol, currentTimeframe);
      }, 500);
    }

    // 다크모드 초기화
    function initializeDarkMode() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const themeToggle = document.querySelector('.theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const currentTheme = document.documentElement.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          
          // TradingView 차트 테마 즉시 업데이트
          setTimeout(() => {
            if (tradingViewWidget && currentChartSymbol) {
              initializeTradingViewChart(currentChartSymbol, currentTimeframe);
            }
          }, 100);
        });
      }
    }

    // 다크모드 초기화
    initializeDarkMode();
    
    // 테마 변경 감지 (헤더의 테마 토글 버튼용)
    document.addEventListener('themeChanged', () => {
      setTimeout(() => {
        if (tradingViewWidget && currentChartSymbol) {
          initializeTradingViewChart(currentChartSymbol, currentTimeframe);
        }
      }, 100);
    });

    // 대시보드 관리 클래스
    class Dashboard {
      constructor() {
        this.currentSymbol = 'BTCUSDT';
        this.tvWidget = null;
        this.isChartReady = false;
        this.init();
      }
      
      init() {
        this.bindEvents();
      }
      

      

      
      bindEvents() {
        // 차트 심볼 변경
        const chartSymbol = document.getElementById('chart-symbol');
        if (chartSymbol) {
          chartSymbol.addEventListener('change', (e) => {
            this.changeSymbol(e.target.value);
          });
        }
      }
      
      changeSymbol(symbol) {
        this.currentSymbol = symbol;
        console.log('심볼 변경:', symbol);
        
        // 전역 차트 심볼 변경 함수 호출
        if (typeof changeChartSymbol === 'function') {
          changeChartSymbol(symbol);
        } else {
          console.warn('changeChartSymbol 함수를 찾을 수 없습니다.');
        }
      }
    }

    // 코인 테이블 기능
    class CryptoTable {
      constructor() {
        this.coins = [];
        this.filteredCoins = [];
        this.currentPage = 1;
        this.itemsPerPage = 50;
        this.sortField = 'rank';
        this.sortDirection = 'asc';
        this.currentCategory = 'all';
        this.searchTerm = '';
        
        this.init();
      }
      
      async init() {
        this.bindEvents();
        await this.loadData();
        this.render();
        
        // 5분마다 자동 업데이트 (서버 캐시와 동기화)
        setInterval(() => {
          this.loadData();
        }, 300000);
      }
      
      bindEvents() {
        // 탭 전환
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            this.currentCategory = e.target.dataset.category;
            this.currentPage = 1;
            this.filterAndSort();
          });
        });
        
        // 검색
        const searchInput = document.getElementById('coin-search');
        if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          this.searchTerm = e.target.value.toLowerCase();
          this.currentPage = 1;
          this.filterAndSort();
        });
        }
        
        // 새로고침
        const refreshBtn = document.getElementById('refresh-data');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
          this.loadData();
        });
        }
        
        // 정렬
        document.querySelectorAll('.sortable').forEach(th => {
          th.addEventListener('click', () => {
            const field = th.dataset.sort;
            if (this.sortField === field) {
              this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
              this.sortField = field;
              this.sortDirection = 'asc';
            }
            this.updateSortHeaders();
            this.filterAndSort();
          });
        });
        
        // 페이지네이션
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        
        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
          if (this.currentPage > 1) {
            this.currentPage--;
            this.render();
          }
        });
        }
        
        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
          const totalPages = Math.ceil(this.filteredCoins.length / this.itemsPerPage);
          if (this.currentPage < totalPages) {
            this.currentPage++;
            this.render();
          }
        });
        }
      }
      
      async loadData() {
        const refreshBtn = document.getElementById('refresh-data');
        if (refreshBtn) {
        refreshBtn.classList.add('loading');
        }
        
        try {
          console.log('CoinGecko API에서 직접 데이터 로딩 중...');
          
          // 직접 CoinGecko API 호출 (로컬/프로덕션 모두)
            const promises = [];
            for (let page = 1; page <= 2; page++) {
              promises.push(
                fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=${page}&sparkline=true&price_change_percentage=1h%2C24h%2C7d`)
                  .then(res => {
                    if (!res.ok) {
                      throw new Error(`API 응답 오류: ${res.status}`);
                    }
                    return res.json();
                  })
              );
            }
            
            const results = await Promise.allSettled(promises);
          let allData = [];
          
            for (const result of results) {
              if (result.status === 'fulfilled') {
                allData.push(...result.value);
              }
            }
            
          if (allData.length === 0) {
            throw new Error('모든 API 요청이 실패했습니다');
          }
          
            // 데이터 처리
            const processedData = allData.map((coin, index) => ({
            id: coin.id,
              rank: coin.market_cap_rank || index + 1,
              name: coin.name?.replace(/['">\s]+/g, ' ').trim() || '',
              symbol: coin.symbol?.replace(/['">\s]+/g, ' ').trim().toUpperCase() || '',
            image: coin.image,
            price: coin.current_price,
            change1h: coin.price_change_percentage_1h_in_currency || 0,
            change24h: coin.price_change_percentage_24h || 0,
              change7d: coin.price_change_percentage_7d_in_currency || 0,
            volume: coin.total_volume,
              marketCap: coin.market_cap,
              sparkline: coin.sparkline_in_7d ? coin.sparkline_in_7d.price : [],
              lastUpdated: new Date().toISOString()
            }));
            
            // 시가총액 순으로 정렬
            processedData.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
            
            // 순위 재정렬
            processedData.forEach((coin, index) => {
              coin.rank = index + 1;
            });
            
            // 추가 데이터 계산
          const data = processedData.map(coin => ({
              ...coin,
              fundingRate: this.calculateFundingRate(coin),
            openInterest: this.calculateOpenInterest(coin),
            oiChange1h: this.calculateOIChange(coin, '1h'),
            oiChange4h: this.calculateOIChange(coin, '4h'),
            liquidation1h: this.calculateLiquidation(coin, '1h'),
              liquidation24h: this.calculateLiquidation(coin, '24h')
            }));
            
            console.log(`${data.length}개 코인 데이터 처리 완료`);
          
          // 데이터 매핑
          this.coins = data.map(coin => ({
            id: coin.id,
            rank: coin.rank,
            name: coin.name,
            symbol: coin.symbol,
            image: coin.image,
            price: coin.price,
            change1h: coin.change1h,
            change24h: coin.change24h,
            fundingRate: coin.fundingRate,
            volume: coin.volume,
            openInterest: coin.openInterest,
            oiChange1h: coin.oiChange1h,
            oiChange4h: coin.oiChange4h,
            marketCap: coin.marketCap,
            liquidation1h: coin.liquidation1h,
            liquidation24h: coin.liquidation24h,
            sparkline: coin.sparkline || []
          }));
          
          this.filterAndSort();
          
        } catch (error) {
          console.error('데이터 로딩 실패:', error);
          
          // 에러 표시
          const tbody = document.getElementById('crypto-table-body');
          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="14" class="loading-row" style="text-align: center; padding: 2rem;">
                  <div style="color: var(--text-secondary);">
                    <i class="fas fa-exclamation-triangle" style="margin-bottom: 0.5rem; font-size: 1.5rem;"></i>
                    <div>실시간 데이터를 불러올 수 없습니다</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                      CoinGecko API 호출에 실패했습니다. 잠시 후 다시 시도해주세요.
                    </div>
                    <button onclick="cryptoTable.loadData()" style="
                      margin-top: 1rem; 
                      padding: 0.5rem 1rem; 
                      border: 1px solid var(--border-strong); 
                      border-radius: 6px; 
                      background: var(--accent-blue); 
                      color: white; 
                      cursor: pointer;
                      font-size: 0.9rem;
                    ">
                      <i class="fas fa-sync-alt"></i> 다시 시도
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }
        } finally {
          if (refreshBtn) {
          refreshBtn.classList.remove('loading');
          }
        }
      }
      

      
      filterAndSort() {
        let filtered = [...this.coins];
        
               // 카테고리 필터링
         switch (this.currentCategory) {
           case 'gainers':
             filtered = filtered.filter(coin => coin.change24h > 0);
             break;
           case 'losers':
             filtered = filtered.filter(coin => coin.change24h < 0);
             break;
         }
        
        // 검색 필터링
        if (this.searchTerm) {
          filtered = filtered.filter(coin => 
            coin.name.toLowerCase().includes(this.searchTerm) ||
            coin.symbol.toLowerCase().includes(this.searchTerm)
          );
        }
        
        // 정렬
        filtered.sort((a, b) => {
          let aVal = a[this.sortField];
          let bVal = b[this.sortField];
          
          if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
          }
          
          if (this.sortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });
        
        this.filteredCoins = filtered;
        this.currentPage = 1;
        this.render();
      }
      
      render() {
        const tbody = document.getElementById('crypto-table-body');
        if (!tbody) return;
        
        const startIndex = (this.currentPage - 1) * this.itemsPerPage;
        const endIndex = startIndex + this.itemsPerPage;
        const pageCoins = this.filteredCoins.slice(startIndex, endIndex);
        
        if (pageCoins.length === 0) {
                     tbody.innerHTML = `
             <tr>
               <td colspan="14" class="loading-row">
                 ${this.coins.length === 0 ? 
                   '<div class="loading-spinner"></div> 데이터 로딩 중...' : 
                   '검색 결과가 없습니다.'
                 }
               </td>
             </tr>
           `;
          return;
        }
        
                 tbody.innerHTML = pageCoins.map(coin => {
           const fallbackSvg = this.createFallbackSvg(coin.symbol);
           return `
           <tr data-coin-id="${coin.id}" ${coin.id === 'bitcoin' ? 'style="cursor: pointer;" onclick="window.location.href=\'/currencies/bitcoin/\'"' : ''}>
             <td>${coin.rank}</td>
             <td>
               <div class="coin-info">
                 <img src="${coin.image}" alt="${coin.name}" class="coin-logo" 
                      onerror="this.src='${fallbackSvg}'">
                 <div class="coin-details">
                   <div class="coin-name">${coin.name}</div>
                   <div class="coin-symbol">${coin.symbol}</div>
                 </div>
               </div>
             </td>
             <td class="price">$${this.formatPrice(coin.price)}</td>
             <td><span class="change ${this.getChangeClass(coin.change1h)}">${this.formatPercent(coin.change1h)}</span></td>
             <td><span class="change ${this.getChangeClass(coin.change24h)}">${this.formatPercent(coin.change24h)}</span></td>
             <td><span class="change ${this.getChangeClass(coin.fundingRate)}">${this.formatPercent(coin.fundingRate)}</span></td>
             <td class="volume">$${this.formatNumber(coin.volume)}</td>
             <td class="oi">$${this.formatNumber(coin.openInterest)}</td>
             <td><span class="change ${this.getChangeClass(coin.oiChange1h)}">${this.formatPercent(coin.oiChange1h)}</span></td>
             <td><span class="change ${this.getChangeClass(coin.oiChange4h)}">${this.formatPercent(coin.oiChange4h)}</span></td>
             <td class="market-cap">$${this.formatNumber(coin.marketCap)}</td>
             <td class="liquidation">$${this.formatNumber(coin.liquidation1h)}</td>
             <td class="liquidation">$${this.formatNumber(coin.liquidation24h)}</td>
             <td>
               <canvas class="mini-chart" width="60" height="30" 
                      onclick="window.open('https://www.tradingview.com/chart/?symbol=BINANCE:${coin.symbol}USDT', '_blank')"
                       data-sparkline='${JSON.stringify(coin.sparkline)}'></canvas>
             </td>
           </tr>
           `;
         }).join('');
        
        // 미니 차트 그리기
        this.drawMiniCharts();
        
        // 페이지네이션 업데이트
        this.updatePagination();
      }
      
      drawMiniCharts() {
        document.querySelectorAll('.mini-chart').forEach(canvas => {
          const sparkline = JSON.parse(canvas.dataset.sparkline || '[]');
          if (!sparkline || sparkline.length === 0) return;
          
          const ctx = canvas.getContext('2d');
          const width = canvas.width;
          const height = canvas.height;
          
          ctx.clearRect(0, 0, width, height);
          
          const min = Math.min(...sparkline);
          const max = Math.max(...sparkline);
          const range = max - min;
          
          if (range === 0) return;
          
          ctx.strokeStyle = sparkline[sparkline.length - 1] > sparkline[0] ? '#10b981' : '#ef4444';
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          
          sparkline.forEach((price, index) => {
            const x = (index / (sparkline.length - 1)) * width;
            const y = height - ((price - min) / range) * height;
            
            if (index === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          
          ctx.stroke();
        });
      }
      
      updateSortHeaders() {
        document.querySelectorAll('.sortable').forEach(th => {
          th.classList.remove('sort-asc', 'sort-desc');
          if (th.dataset.sort === this.sortField) {
            th.classList.add(`sort-${this.sortDirection}`);
          }
        });
      }
      
      updatePagination() {
        const totalPages = Math.ceil(this.filteredCoins.length / this.itemsPerPage);
        
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        
        if (prevBtn) prevBtn.disabled = this.currentPage === 1;
        if (nextBtn) nextBtn.disabled = this.currentPage === totalPages || totalPages === 0;
        if (pageInfo) {
          const startItem = (this.currentPage - 1) * this.itemsPerPage + 1;
          const endItem = Math.min(this.currentPage * this.itemsPerPage, this.filteredCoins.length);
          pageInfo.textContent = `${startItem}-${endItem} / ${this.filteredCoins.length} (페이지 ${this.currentPage}/${totalPages || 1})`;
        }
      }
      
      formatPrice(price) {
        if (price >= 1) {
          return price.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        } else {
          return price.toFixed(6);
        }
      }
      
      formatPercent(percent) {
        const sign = percent >= 0 ? '+' : '';
        return `${sign}${percent.toFixed(2)}%`;
      }
      
      formatNumber(num) {
        if (num >= 1e12) {
          return (num / 1e12).toFixed(2) + 'T';
        } else if (num >= 1e9) {
          return (num / 1e9).toFixed(2) + 'B';
        } else if (num >= 1e6) {
          return (num / 1e6).toFixed(2) + 'M';
        } else if (num >= 1e3) {
          return (num / 1e3).toFixed(2) + 'K';
        } else {
          return num.toLocaleString();
        }
      }
      
      getChangeClass(change) {
        if (change > 0) return 'positive';
        if (change < 0) return 'negative';
        return 'neutral';
      }
      
      // 텍스트 정리 함수 (B'"> 오류 해결)
      cleanText(text) {
        if (!text) return '';
        return text
          .replace(/[A-Z]'">/g, '') // B'"> 같은 패턴 제거
          .replace(/['">\s]+/g, ' ') // 따옴표, 꺽쇠, 공백 정리
          .trim();
      }
      
      // 백업 SVG 생성
      createFallbackSvg(symbol) {
        const firstChar = symbol ? symbol.charAt(0) : '?';
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
          <circle cx="16" cy="16" r="16" fill="#ddd"/>
          <text x="16" y="20" text-anchor="middle" fill="#999" font-size="10">${firstChar}</text>
        </svg>`;
        return 'data:image/svg+xml,' + encodeURIComponent(svg);
      }
      
      // 추가 데이터 계산 함수들
      calculateFundingRate(coin) {
        const volatility = Math.abs(coin.change24h || 0);
        const volumeRatio = Math.min((coin.volume || 0) / (coin.marketCap || 1), 1);
        
        let funding = (Math.sin(coin.rank || 1) * 0.05) + (volatility * 0.01);
        funding *= (1 + volumeRatio * 0.5);
        
        return Math.max(-0.1, Math.min(0.1, funding));
      }
      
      calculateOpenInterest(coin) {
        const baseRatio = 0.08;
        const volumeBoost = Math.min((coin.volume || 0) / (coin.marketCap || 1), 0.5) * 0.1;
        const rankBoost = Math.max(0, (100 - (coin.rank || 100)) / 1000);
        
        return (coin.marketCap || 0) * (baseRatio + volumeBoost + rankBoost);
      }

      calculateOIChange(coin, period) {
        const priceChange = period === '1h' ? 
          (coin.change1h || 0) : 
          (coin.change24h || 0) / 4;
        
        const correlation = -0.3 + (Math.random() * 0.6);
        return priceChange * correlation;
      }
      
      calculateLiquidation(coin, period) {
        const volatility = Math.abs(coin.change24h || 0);
        const volume = coin.volume || 0;
        
        const liquidationRatio = Math.min(volatility * 0.02, 0.1);
        const baseLiquidation = volume * liquidationRatio;
        
        return period === '24h' ? baseLiquidation : baseLiquidation / 24;
      }
      

      
      // TradingView 열기
      openTradingView(symbol) {
        const url = `https://www.tradingview.com/chart/?symbol=BINANCE:${symbol}`;
        window.open(url, '_blank');
      }
    }

    // 페이지 로드 후 초기화
    let dashboard;
    let cryptoTable;
    
    // 대시보드 초기화 함수
    function initializeDashboard() {
      // 분봉 드롭다운 이벤트 리스너 추가
      const timeframeSelect = document.getElementById('chart-timeframe');
      if (timeframeSelect) {
        timeframeSelect.addEventListener('change', function() {
          const timeframe = this.value;
          changeTimeframe(timeframe);
        });
      }
      
      // 차트 심볼 변경 이벤트 리스너
      const chartSymbol = document.getElementById('chart-symbol');
      if (chartSymbol) {
        chartSymbol.addEventListener('change', function() {
          const symbol = this.value;
          changeChartSymbol(symbol);
        });
      }
      
      // 대시보드 초기화
      try {
        dashboard = new Dashboard();
      } catch (error) {
        console.error('Dashboard 초기화 실패:', error);
      }
      
      // 코인 테이블 초기화
      setTimeout(() => {
        try {
          cryptoTable = new CryptoTable();
        } catch (error) {
          console.error('CryptoTable 초기화 실패:', error);
        }
      }, 1000);
    }
    
    // Firebase 초기화 완료 후 대시보드 초기화
    document.addEventListener('DOMContentLoaded', function() {
      // Firebase가 이미 초기화되었는지 확인
      if (window.firebaseInitialized && window.firebaseDB) {
        initializeDashboard();
      } else {
        // Firebase 초기화를 기다림
        const checkFirebase = setInterval(() => {
          if (window.firebaseInitialized && window.firebaseDB) {
            clearInterval(checkFirebase);
            initializeDashboard();
          }
        }, 100);
        
        // Firebase 초기화 완료 이벤트 리스너
        window.addEventListener('firebaseInitialized', function() {
          clearInterval(checkFirebase);
          initializeDashboard();
        });
        
        // 10초 후 타임아웃
        setTimeout(() => {
          clearInterval(checkFirebase);
          console.warn('Firebase 초기화 타임아웃');
          initializeDashboard(); // Firebase 없이도 다른 기능들은 초기화
        }, 10000);
      }
    });
    
    // 복리 계산기 초기화
    document.addEventListener('DOMContentLoaded', function() {
      // 복리 계산기 초기화
      if (typeof window.CompoundCalculator !== 'undefined') {
        window.compoundCalculator = new window.CompoundCalculator();
        console.log('💰 복리 계산기 초기화 완료');
      } else {
        console.warn('복리 계산기 클래스를 찾을 수 없습니다');
      }
    });
  </script>

</body>
</html>